<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>House</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/2.0.3/fetch.js"></script>
  <script src="https://unpkg.com/vue" charset="utf-8"></script>
  <style>
    .switch { padding: 2px; font-family: arial }
    .switch button { padding: 7px 20px 8px 20px; width: 70px; height: 31px; }
    .title { display: inline-block; width: 150px; }
    .log-view { margin-top: 10px; padding-top: 10px; border-top: solid 1px black; height: 200px; overflow-y: scroll; }
    .log-entry { font-size: 10px; font-family: monospace; white-space: pre; }
  </style>
</head>
<body>
  <div id="app">
    <my-output v-for="sw in switches" :key="sw.id" :title="sw.title" :id="sw.id"></my-output>
    <log-view :messages="messages"></log-view>
  </div>

  <script type="text/javascript">
    Vue.component('my-output', {
      template: '' +
      '  <div class="switch">' +
      '    <span class="title">{{ title }}</span>' +
      '    <button @click="on">ON</button>' +
      '    <button @click="off">OFF</button>' +
      '  </div>'
      ,
      props: {
        id: { required: true },
        title: { default: 'SWITCH' }
      },
      methods: {
        switch(state) {
          fetch(`/api/switch/${this.id}`, {
            method: 'POST',
            body: `{ "state": "${state}" }`,
            headers: { 'Content-Type': 'application/json' }
          })
          .catch(function(e) { app.messages.push(`ERROR: ${e}`); })
        },
        on() {
          this.switch('on')
        },
        off() {
          this.switch('off')
        }
      }
    });
  </script>

  <script>
    Vue.component('log-view', {
      template: '' +
      '  <div class="log-view">' +
      '    <div class="log-entry" v-for="message in list">{{ message }}</div>' +
      '  </div>'
      ,
      props: {
        messages: { default: [] }
      },
      computed: {
        list() {
          return this.messages.reverse()
        }
      }
    })
  </script>

  <script type="text/javascript">
    var app = new Vue({
      el: '#app',
      components: [ 'MyOutput' ],
      data: {
        messages: [],
        switches: [
          { id: "test" },
          { title: "Łazienka 1", id: "bathroom1" },
          { title: "Łazienka 2", id: "bathroom2" },
          { title: "Kibel", id: "restroom" },
          { title: "Kuchnia", id: "kitchen" },
          { title: "Garderoba", id: "garderoba" },
          { title: "Pokój Lewy", id: "big-room-left" },
          { title: "Pokój Prawy", id: "big-room-right" },
          { title: "Czarek", id: "czarek" },
          { title: "Adaś", id: "adas" },
        ]
      }
    })

    var ls = new WebSocket('ws://' + location.host + '/echo')
    ls.onmessage = function(e) {
      app.messages.push(new Date().toGMTString() + " - " + e.data)
    }

//    app.messages.push('FETCH: ' + window.fetch)
  </script>
</body>
</html>
